<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Channels</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            background: #36393f;
            min-height: 100vh;
            font-family: 'Whitney', 'Helvetica Neue', Helvetica, Arial, sans-serif;
        }
        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1rem;
        }
        video {
            width: 100%;
            border-radius: 8px;
            background: #000;
        }
        .channel-item {
            padding: 8px 12px;
            margin: 2px 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.15s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .channel-item:hover {
            background: #3c3f45;
        }
        .channel-active {
            background: #404249 !important;
        }
        .user-item {
            padding: 6px 12px;
            margin: 2px 8px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            border: 2px solid #2f3136;
        }
        .status-online { background: #3ba55c; }
        .status-speaking { 
            background: #3ba55c; 
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(59, 165, 92, 0.7); }
            50% { box-shadow: 0 0 0 6px rgba(59, 165, 92, 0); }
        }
        .control-btn {
            background: #3a3d44;
            border-radius: 4px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            color: #b9bbbe;
        }
        .control-btn:hover {
            background: #4e5058;
        }
        .control-btn.active {
            background: #3ba55c;
            color: white;
        }
        .control-btn.muted {
            background: #ed4245;
            color: white;
        }
        .sidebar {
            background: #2f3136;
            height: 100vh;
            width: 240px;
            display: flex;
            flex-direction: column;
        }
        .main-content {
            background: #36393f;
            flex: 1;
            height: 100vh;
            overflow-y: auto;
        }
        .user-panel {
            background: #292b2f;
            padding: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: auto;
        }
        .avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #5865f2, #7289da);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        .login-screen {
            background: #5865f2;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .video-container {
            position: relative;
            background: #1e1f22;
            border-radius: 8px;
            overflow: hidden;
        }
        .video-label {
            position: absolute;
            bottom: 8px;
            left: 8px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <!-- –≠–∫—Ä–∞–Ω —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ -->
    <div id="loginScreen" class="login-screen">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-md">
            <div class="text-center mb-6">
                <div class="text-6xl mb-4">üéÆ</div>
                <h1 class="text-3xl font-bold text-gray-800 mb-2">–° –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º!</h1>
                <p class="text-gray-500">–†–∞–¥—ã –≤–∏–¥–µ—Ç—å –≤–∞—Å —Å–Ω–æ–≤–∞!</p>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">–ù–ò–ö–ù–ï–ô–ú</label>
                    <input 
                        type="text" 
                        id="nicknameInput" 
                        placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –Ω–∏–∫"
                        class="w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded focus:outline-none focus:border-blue-500"
                        maxlength="20"
                    />
                </div>
                <button 
                    onclick="login()"
                    class="w-full bg-blue-600 text-white py-3 rounded hover:bg-blue-700 transition font-semibold"
                    style="background: #5865f2;"
                >
                    –í–æ–π—Ç–∏
                </button>
            </div>
        </div>
    </div>

    <!-- –ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω -->
    <div id="mainScreen" class="hidden flex">
        <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
        <div class="sidebar">
            <div style="padding: 12px; border-bottom: 1px solid #202225; color: #fff; font-weight: 600; font-size: 16px;">
                Voice Chat
            </div>
            
            <div style="padding: 8px 0; flex: 1; overflow-y: auto;">
                <div style="padding: 8px 16px; color: #96989d; font-size: 12px; font-weight: 600; text-transform: uppercase; margin-top: 16px;">
                    –ì–æ–ª–æ—Å–æ–≤—ã–µ –∫–∞–Ω–∞–ª—ã
                </div>
                
                <!-- –ö–∞–Ω–∞–ª 1 -->
                <div id="channel1Item" class="channel-item" onclick="joinChannel('channel1')">
                    <svg width="24" height="24" viewBox="0 0 24 24" style="color: #96989d;">
                        <path fill="currentColor" d="M12 3C10.34 3 9 4.34 9 6C9 7.66 10.34 9 12 9C13.66 9 15 7.66 15 6C15 4.34 13.66 3 12 3ZM12 15C10.34 15 9 16.34 9 18C9 19.66 10.34 21 12 21C13.66 21 15 19.66 15 18C15 16.34 13.66 15 12 15ZM18 12C16.34 12 15 13.34 15 15C15 16.66 16.34 18 18 18C19.66 18 21 16.66 21 15C21 13.34 19.66 12 18 12ZM6 12C4.34 12 3 13.34 3 15C3 16.66 4.34 18 6 18C7.66 18 9 16.66 9 15C9 13.34 7.66 12 6 12Z"/>
                    </svg>
                    <div style="flex: 1;">
                        <div style="color: #dcddde; font-size: 14px; font-weight: 500;">üéÆ –û–±—â–∏–π —á–∞—Ç</div>
                        <div style="color: #96989d; font-size: 12px;"><span id="channel1Count">0</span> —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</div>
                    </div>
                    <span id="channel1Status" style="color: #96989d;">üîä</span>
                </div>

                <!-- –ö–∞–Ω–∞–ª 2 -->
                <div id="channel2Item" class="channel-item" onclick="joinChannel('channel2')">
                    <svg width="24" height="24" viewBox="0 0 24 24" style="color: #96989d;">
                        <path fill="currentColor" d="M12 3C10.34 3 9 4.34 9 6C9 7.66 10.34 9 12 9C13.66 9 15 7.66 15 6C15 4.34 13.66 3 12 3ZM12 15C10.34 15 9 16.34 9 18C9 19.66 10.34 21 12 21C13.66 21 15 19.66 15 18C15 16.34 13.66 15 12 15ZM18 12C16.34 12 15 13.34 15 15C15 16.66 16.34 18 18 18C19.66 18 21 16.66 21 15C21 13.34 19.66 12 18 12ZM6 12C4.34 12 3 13.34 3 15C3 16.66 4.34 18 6 18C7.66 18 9 16.66 9 15C9 13.34 7.66 12 6 12Z"/>
                    </svg>
                    <div style="flex: 1;">
                        <div style="color: #dcddde; font-size: 14px; font-weight: 500;">üéµ –ú—É–∑—ã–∫–∞ –∏ –æ—Ç–¥—ã—Ö</div>
                        <div style="color: #96989d; font-size: 12px;"><span id="channel2Count">0</span> —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</div>
                    </div>
                    <span id="channel2Status" style="color: #96989d;">üîä</span>
                </div>

                <div id="currentChannelInfo" class="hidden" style="padding: 8px 16px; margin: 8px; background: #404249; border-radius: 4px;">
                    <div style="color: #00b0f4; font-size: 12px; font-weight: 600; margin-bottom: 8px;">
                        –ü–æ–¥–∫–ª—é—á–µ–Ω–æ: <span id="currentChannelName"></span>
                    </div>
                    <button onclick="leaveChannel()" style="width: 100%; background: #ed4245; color: white; padding: 6px; border-radius: 3px; font-size: 14px; border: none; cursor: pointer;">
                        –û—Ç–∫–ª—é—á–∏—Ç—å—Å—è
                    </button>
                </div>
            </div>

            <!-- –ü–∞–Ω–µ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤–Ω–∏–∑—É -->
            <div class="user-panel">
                <div class="avatar">
                    <span id="avatarLetter">U</span>
                </div>
                <div style="flex: 1; overflow: hidden;">
                    <div style="color: #fff; font-size: 14px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                        <span id="userNickname"></span>
                    </div>
                    <div style="color: #b9bbbe; font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                        #<span id="userId"></span>
                    </div>
                </div>
                <div style="display: flex; gap: 8px;">
                    <button id="micBtn" class="control-btn" onclick="toggleMic()" title="–ú–∏–∫—Ä–æ—Ñ–æ–Ω">
                        <span id="micIcon">üîá</span>
                    </button>
                    <button id="camBtn" class="control-btn" onclick="toggleCamera()" title="–ö–∞–º–µ—Ä–∞">
                        <span id="camIcon">üìπ</span>
                    </button>
                    <button id="screenBtn" class="control-btn" onclick="toggleScreen()" title="–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è">
                        <span id="screenIcon">üñ•Ô∏è</span>
                    </button>
                    <button class="control-btn" onclick="logout()" title="–í—ã–π—Ç–∏" style="background: #ed4245;">
                        üö™
                    </button>
                </div>
            </div>
        </div>

        <!-- –û—Å–Ω–æ–≤–Ω–∞—è –æ–±–ª–∞—Å—Ç—å -->
        <div class="main-content">
            <div style="padding: 16px; border-bottom: 1px solid #202225; color: #fff; font-weight: 600; display: flex; align-items: center; gap: 12px;">
                <svg width="24" height="24" viewBox="0 0 24 24" style="color: #96989d;">
                    <path fill="currentColor" d="M12 2C6.486 2 2 6.486 2 12C2 17.514 6.486 22 12 22C17.514 22 22 17.514 22 12C22 6.486 17.514 2 12 2ZM12 4C16.411 4 20 7.589 20 12C20 16.411 16.411 20 12 20C7.589 20 4 16.411 4 12C4 7.589 7.589 4 12 4Z"/>
                </svg>
                <span id="mainChannelName">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞–Ω–∞–ª</span>
            </div>

            <div style="padding: 20px;">
                <div id="emptyState" style="text-align: center; padding: 80px 20px; color: #96989d;">
                    <div style="font-size: 80px; margin-bottom: 16px;">üéß</div>
                    <div style="font-size: 20px; font-weight: 600; color: #dcddde; margin-bottom: 8px;">–ù–µ—Ç –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</div>
                    <div style="font-size: 14px;">–í—ã –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω—ã –Ω–∏ –∫ –æ–¥–Ω–æ–º—É –≥–æ–ª–æ—Å–æ–≤–æ–º—É –∫–∞–Ω–∞–ª—É.</div>
                </div>

                <div id="videoContainer" class="video-grid hidden">
                    <!-- –ú–æ–µ –≤–∏–¥–µ–æ -->
                    <div class="video-container">
                        <video id="myVideo" autoplay muted playsinline style="transform: scaleX(-1);"></video>
                        <div class="video-label">
                            <span id="myNameLabel">–í—ã</span>
                        </div>
                    </div>
                    
                    <!-- –í–∏–¥–µ–æ –¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
                    <div id="remoteVideos"></div>
                </div>

                <!-- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è -->
                <div id="instructions" style="margin-top: 40px; background: #2f3136; padding: 16px; border-radius: 8px; border-left: 4px solid #5865f2;">
                    <div style="color: #00b0f4; font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                        <svg width="20" height="20" viewBox="0 0 24 24">
                            <path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                        </svg>
                        –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è
                    </div>
                    <ul style="color: #b9bbbe; font-size: 14px; line-height: 1.8; list-style: none; padding: 0;">
                        <li>‚úÖ –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –≥–æ–ª–æ—Å–æ–≤–æ–π –∫–∞–Ω–∞–ª —Å–ª–µ–≤–∞, —á—Ç–æ–±—ã –≤–æ–π—Ç–∏</li>
                        <li>üé§ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –≤–Ω–∏–∑—É —Å–ª–µ–≤–∞ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–∏–∫—Ä–æ—Ñ–æ–Ω–æ–º, –∫–∞–º–µ—Ä–æ–π –∏ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–µ–π —ç–∫—Ä–∞–Ω–∞</li>
                        <li>üîó –ß—Ç–æ–±—ã –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –¥—Ä—É–≥—É, –æ—Ç–∫—Ä–æ–π—Ç–µ –∫–æ–Ω—Å–æ–ª—å (F12) –∏ –≤–≤–µ–¥–∏—Ç–µ: <code style="background: #202225; padding: 2px 6px; border-radius: 3px; color: #00b0f4;">connectToUser("ID_–¥—Ä—É–≥–∞")</code></li>
                        <li>üìã –í–∞—à ID –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤–Ω–∏–∑—É —Å–ª–µ–≤–∞ - –ø–æ–¥–µ–ª–∏—Ç–µ—Å—å –∏–º —Å –¥—Ä—É–∑—å—è–º–∏</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        let peer;
        let myStream;
        let currentChannel = null;
        let connections = {};
        let micEnabled = false;
        let cameraEnabled = false;
        let screenEnabled = false;
        let userNickname = '';

        // –í—Ö–æ–¥
        function login() {
            const nickname = document.getElementById('nicknameInput').value.trim();
            if (!nickname) {
                alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫!');
                return;
            }

            userNickname = nickname;
            localStorage.setItem('nickname', nickname);

            // –°–æ–∑–¥–∞–µ–º Peer —Å —Å–ª—É—á–∞–π–Ω—ã–º ID
            const peerId = 'user_' + Math.random().toString(36).substr(2, 9);
            peer = new Peer(peerId);

            peer.on('open', (id) => {
                console.log('–ú–æ–π ID:', id);
                const shortId = id.substring(0, 8);
                document.getElementById('userId').textContent = shortId;
                document.getElementById('userNickname').textContent = nickname;
                document.getElementById('myNameLabel').textContent = nickname;
                document.getElementById('avatarLetter').textContent = nickname.charAt(0).toUpperCase();
                
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainScreen').classList.remove('hidden');

                // –°–ª—É—à–∞–µ–º –≤—Ö–æ–¥—è—â–∏–µ –∑–≤–æ–Ω–∫–∏
                peer.on('call', (call) => {
                    console.log('–í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫ –æ—Ç:', call.peer);
                    
                    // –û—Ç–≤–µ—á–∞–µ–º –Ω–∞ –∑–≤–æ–Ω–æ–∫ —Å –Ω–∞—à–∏–º –ø–æ—Ç–æ–∫–æ–º
                    call.answer(myStream);

                    call.on('stream', (remoteStream) => {
                        addRemoteVideo(call.peer, remoteStream);
                    });

                    connections[call.peer] = call;
                });
            });

            peer.on('error', (err) => {
                console.error('Peer error:', err);
                alert('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ' + err.message);
            });
        }

        // –í—ã—Ö–æ–¥
        function logout() {
            if (peer) peer.destroy();
            if (myStream) {
                myStream.getTracks().forEach(track => track.stop());
            }
            localStorage.removeItem('nickname');
            location.reload();
        }

        // –í—Ö–æ–¥ –≤ –∫–∞–Ω–∞–ª
        async function joinChannel(channelId) {
            if (currentChannel === channelId) return;

            if (currentChannel) {
                // –£–±–∏—Ä–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É —Å—Ç–∞—Ä–æ–≥–æ –∫–∞–Ω–∞–ª–∞
                document.getElementById(currentChannel + 'Item').classList.remove('channel-active');
                document.getElementById(currentChannel + 'Status').textContent = 'üîä';
            }

            currentChannel = channelId;
            const channelName = channelId === 'channel1' ? 'üéÆ –û–±—â–∏–π —á–∞—Ç' : 'üéµ –ú—É–∑—ã–∫–∞ –∏ –æ—Ç–¥—ã—Ö';
            
            // –û–±–Ω–æ–≤–ª—è–µ–º UI
            document.getElementById('currentChannelInfo').classList.remove('hidden');
            document.getElementById('currentChannelName').textContent = channelName;
            document.getElementById('mainChannelName').textContent = channelName;
            document.getElementById(channelId + 'Status').textContent = '‚úÖ';
            document.getElementById(channelId + 'Item').classList.add('channel-active');

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—É—Å—Ç–æ–π –ø–æ—Ç–æ–∫
            myStream = new MediaStream();
            
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('videoContainer').classList.remove('hidden');
            document.getElementById('instructions').style.display = 'block';
            
            console.log('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ –∫–∞–Ω–∞–ª—É:', channelId);
            console.log('–í–∞—à ID –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:', peer.id);
        }

        // –í—ã—Ö–æ–¥ –∏–∑ –∫–∞–Ω–∞–ª–∞
        function leaveChannel() {
            if (!currentChannel) return;

            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –º–µ–¥–∏–∞
            if (myStream) {
                myStream.getTracks().forEach(track => track.stop());
            }

            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
            Object.values(connections).forEach(conn => {
                if (conn.close) conn.close();
            });
            connections = {};

            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            document.getElementById(currentChannel + 'Status').textContent = 'üîä';
            document.getElementById(currentChannel + 'Item').classList.remove('channel-active');
            
            const oldChannel = currentChannel;
            currentChannel = null;
            micEnabled = false;
            cameraEnabled = false;
            screenEnabled = false;

            // –û–±–Ω–æ–≤–ª—è–µ–º UI
            document.getElementById('currentChannelInfo').classList.add('hidden');
            document.getElementById('emptyState').classList.remove('hidden');
            document.getElementById('videoContainer').classList.add('hidden');
            document.getElementById('remoteVideos').innerHTML = '';
            document.getElementById('mainChannelName').textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞–Ω–∞–ª';
            document.getElementById('myVideo').srcObject = null;

            updateMediaButtons();
        }

        // –í–∫–ª—é—á–µ–Ω–∏–µ/–≤—ã–∫–ª—é—á–µ–Ω–∏–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
        async function toggleMic() {
            if (!currentChannel) {
                alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ –∫–∞–Ω–∞–ª!');
                return;
            }

            if (!micEnabled) {
                try {
                    const audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    audioStream.getAudioTracks().forEach(track => {
                        myStream.addTrack(track);
                    });
                    micEnabled = true;
                } catch (err) {
                    alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É');
                    console.error(err);
                    return;
                }
            } else {
                myStream.getAudioTracks().forEach(track => {
                    track.stop();
                    myStream.removeTrack(track);
                });
                micEnabled = false;
            }

            updateMediaButtons();
            updateConnections();
        }

        // –í–∫–ª—é—á–µ–Ω–∏–µ/–≤—ã–∫–ª—é—á–µ–Ω–∏–µ –∫–∞–º–µ—Ä—ã
        async function toggleCamera() {
            if (!currentChannel) {
                alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ –∫–∞–Ω–∞–ª!');
                return;
            }

            if (!cameraEnabled) {
                try {
                    const videoStream = await navigator.mediaDevices.getUserMedia({ video: true });
                    videoStream.getVideoTracks().forEach(track => {
                        myStream.addTrack(track);
                    });
                    cameraEnabled = true;
                    document.getElementById('myVideo').srcObject = myStream;
                } catch (err) {
                    alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ');
                    console.error(err);
                    return;
                }
            } else {
                myStream.getVideoTracks().forEach(track => {
                    if (track.label.indexOf('screen') === -1) {
                        track.stop();
                        myStream.removeTrack(track);
                    }
                });
                cameraEnabled = false;
                if (!screenEnabled) {
                    document.getElementById('myVideo').srcObject = null;
                }
            }

            updateMediaButtons();
            updateConnections();
        }

        // –í–∫–ª—é—á–µ–Ω–∏–µ/–≤—ã–∫–ª—é—á–µ–Ω–∏–µ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ —ç–∫—Ä–∞–Ω–∞
        async function toggleScreen() {
            if (!currentChannel) {
                alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ –∫–∞–Ω–∞–ª!');
                return;
            }

            if (!screenEnabled) {
                try {
                    const screenStream = await navigator.mediaDevices.getDisplayMedia({ 
                        video: { mediaSource: 'screen' } 
                    });
                    
                    // –£–¥–∞–ª—è–µ–º –≤–∏–¥–µ–æ –æ—Ç –∫–∞–º–µ—Ä—ã, –µ—Å–ª–∏ –µ—Å—Ç—å
                    if (cameraEnabled) {
                        myStream.getVideoTracks().forEach(track => {
                            track.stop();
                            myStream.removeTrack(track);
                        });
                        cameraEnabled = false;
                    }

                    screenStream.getVideoTracks().forEach(track => {
                        myStream.addTrack(track);
                        
                        // –ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç —à–∞—Ä–∏–Ω–≥ —á–µ—Ä–µ–∑ –±—Ä–∞—É–∑–µ—Ä
                        track.onended = () => {
                            screenEnabled = false;
                            updateMediaButtons();
                            document.getElementById('myVideo').srcObject = null;
                        };
                    });
                    
                    screenEnabled = true;
                    document.getElementById('myVideo').srcObject = myStream;
                } catch (err) {
                    alert('–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞—á–∞—Ç—å –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—é —ç–∫—Ä–∞–Ω–∞');
                    console.error(err);
                    return;
                }
            } else {
                myStream.getVideoTracks().forEach(track => {
                    track.stop();
                    myStream.removeTrack(track);
                });
                screenEnabled = false;
                document.getElementById('myVideo').srcObject = null;
            }

            updateMediaButtons();
            updateConnections();
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ –º–µ–¥–∏–∞
        function updateMediaButtons() {
            // –ú–∏–∫—Ä–æ—Ñ–æ–Ω
            const micBtn = document.getElementById('micBtn');
            if (micEnabled) {
                micBtn.classList.add('btn-active');
                document.getElementById('micText').textContent = '–ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤–∫–ª';
                document.getElementById('micIcon').textContent = 'üé§';
            } else {
                micBtn.classList.remove('btn-active');
                micBtn.classList.add('bg-gray-400');
                document.getElementById('micText').textContent = '–ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤—ã–∫–ª';
                document.getElementById('micIcon').textContent = 'üîá';
            }

            // –ö–∞–º–µ—Ä–∞
            const camBtn = document.getElementById('camBtn');
            if (cameraEnabled) {
                camBtn.classList.add('btn-active');
                document.getElementById('camText').textContent = '–ö–∞–º–µ—Ä–∞ –≤–∫–ª';
                document.getElementById('camIcon').textContent = 'üìπ';
            } else {
                camBtn.classList.remove('btn-active');
                camBtn.classList.add('bg-gray-400');
                document.getElementById('camText').textContent = '–ö–∞–º–µ—Ä–∞ –≤—ã–∫–ª';
                document.getElementById('camIcon').textContent = 'üìπ';
            }

            // –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —ç–∫—Ä–∞–Ω–∞
            const screenBtn = document.getElementById('screenBtn');
            if (screenEnabled) {
                screenBtn.classList.add('btn-active');
                document.getElementById('screenText').textContent = '–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –≤–∫–ª';
                document.getElementById('screenIcon').textContent = 'üñ•Ô∏è';
            } else {
                screenBtn.classList.remove('btn-active');
                screenBtn.classList.add('bg-gray-400');
                document.getElementById('screenText').textContent = '–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –≤—ã–∫–ª';
                document.getElementById('screenIcon').textContent = 'üñ•Ô∏è';
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π (–æ—Ç–ø—Ä–∞–≤–∫–∞ –Ω–æ–≤–æ–≥–æ –ø–æ—Ç–æ–∫–∞)
        function updateConnections() {
            Object.values(connections).forEach(conn => {
                // –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –º–µ–¥–∏–∞ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å –∑–≤–æ–Ω–æ–∫
                // –≠—Ç–æ —É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è, –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ renegotiation
            });
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ –≤–∏–¥–µ–æ
        function addRemoteVideo(peerId, stream) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ –ª–∏ —É–∂–µ
            if (document.getElementById('video_' + peerId)) return;

            const container = document.createElement('div');
            container.className = 'relative';
            container.id = 'video_' + peerId;

            const video = document.createElement('video');
            video.srcObject = stream;
            video.autoplay = true;
            video.playsinline = true;

            const label = document.createElement('div');
            label.className = 'absolute bottom-2 left-2 bg-black bg-opacity-60 text-white px-3 py-1 rounded-lg text-sm font-semibold';
            label.textContent = '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ' + peerId.substr(0, 8);

            container.appendChild(video);
            container.appendChild(label);
            document.getElementById('remoteVideos').appendChild(container);
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –¥—Ä—É–≥–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é (–º–æ–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å –∏–∑ –∫–æ–Ω—Å–æ–ª–∏)
        function connectToUser(remotePeerId) {
            if (!peer || !currentChannel) {
                console.error('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ –∫–∞–Ω–∞–ª!');
                return;
            }

            const call = peer.call(remotePeerId, myStream);
            
            call.on('stream', (remoteStream) => {
                console.log('–ü–æ–ª—É—á–µ–Ω –ø–æ—Ç–æ–∫ –æ—Ç:', remotePeerId);
                addRemoteVideo(remotePeerId, remoteStream);
            });

            connections[remotePeerId] = call;
        }

        // –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –Ω–∏–∫–∞ –∏–∑ localStorage
        window.addEventListener('load', () => {
            const savedNickname = localStorage.getItem('nickname');
            if (savedNickname) {
                document.getElementById('nicknameInput').value = savedNickname;
            }
        });

        // Enter –¥–ª—è –≤—Ö–æ–¥–∞
        document.getElementById('nicknameInput')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') login();
        });

        console.log('%c –ì–æ–ª–æ—Å–æ–≤—ã–µ –ö–∞–Ω–∞–ª—ã v1.0', 'background: #667eea; color: white; padding: 10px; font-size: 20px;');
        console.log('%c –î–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –¥—Ä—É–≥–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ: connectToUser("ID_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è")', 'color: #667eea; font-size: 12px;');
    </script>
</body>
</html>
